# 用户故事

基于 NoF1.ai 功能分析的用户故事

---

## US-001: 市场数据采集

**作为** 交易系统
**我想要** 实时获取6个币种的市场数据和技术指标
**以便** AI能够基于最新数据做出交易决策

### 验收标准
- [ ] 能够获取 BTC, ETH, SOL, BNB, DOGE, XRP 的实时价格
- [ ] 能够获取3分钟和4小时K线数据
- [ ] 能够计算 EMA(20/50), MACD, RSI(7/14), ATR(3/14) 指标
- [ ] 能够获取开放利息(OI)和资金费率
- [ ] 数据更新延迟 < 5秒
- [ ] API调用失败时自动重试

### 优先级
Must Have

### 工作量估算
M (3-5天)

### 依赖
- HyperLiquid Info API

### 技术注意事项
- 使用 `hyperliquid-python-sdk` 或直接调用 REST API
- 考虑使用 WebSocket 订阅实时数据以降低延迟
- 技术指标计算使用 `pandas-ta` 库

---

## US-002: AI决策生成

**作为** 交易系统
**我想要** 使用LLM分析市场数据并生成交易决策
**以便** 自动执行AI建议的交易策略

### 验收标准
- [ ] 能够格式化市场数据为11k字符的提示词
- [ ] 能够调用 DeepSeek/Qwen API 生成决策
- [ ] 能够解析AI返回的JSON格式决策
- [ ] 决策包含：币种、方向、仓位大小、止损、止盈
- [ ] API调用成本 < $0.01/次
- [ ] 决策生成时间 < 10秒

### 优先级
Must Have

### 工作量估算
M (3-5天)

### 依赖
- US-001: 市场数据采集
- DeepSeek或Qwen API密钥

### 技术注意事项
- 参考 NoF1.ai 的提示词结构
- 实现Provider切换机制(DeepSeek/Qwen/OpenRouter)
- 需要robust的JSON解析和验证

---

## US-003: 交易执行

**作为** 交易系统
**我想要** 根据AI决策自动执行开仓、平仓、止损止盈
**以便** 无需人工干预即可完成交易

### 验收标准
- [ ] 能够执行市价单和限价单
- [ ] 能够设置止损(SL)和止盈(TP)
- [ ] 能够查询当前持仓和订单状态
- [ ] 能够平仓现有持仓
- [ ] 订单执行失败时记录日志并告警
- [ ] 严格执行风险管理规则

### 优先级
Must Have

### 工作量估算
L (5-7天)

### 依赖
- US-002: AI决策生成
- HyperLiquid Trading API 权限

### 技术注意事项
- 使用 HyperLiquid Exchange API (需要私钥)
- 实现订单状态跟踪
- 需要处理部分成交、订单拒绝等异常情况

---

## US-004: 风险管理

**作为** 交易系统
**我想要** 严格的风险控制机制
**以便** 防止过度亏损和爆仓

### 验收标准
- [ ] 单个币种最大持仓限制
- [ ] 账户总持仓限制
- [ ] 单仓位最大亏损 -15% 强制止损
- [ ] 账户最大回撤 -30% 停止交易
- [ ] 最大杠杆限制 ≤10x
- [ ] 每日最大交易次数限制

### 优先级
Must Have

### 工作量估算
M (2-3天)

### 依赖
- US-003: 交易执行

### 技术注意事项
- 在交易执行前验证所有风险规则
- 实时监控持仓和账户状态
- 风险规则可配置

---

## US-005: 自动化交易循环

**作为** 交易系统
**我想要** 每3分钟自动执行一次完整交易流程
**以便** 实现7x24小时自动交易

### 验收标准
- [ ] 每3分钟执行一次交易循环
- [ ] 交易循环包含：数据采集 → AI决策 → 执行交易
- [ ] 异常发生时记录日志并继续运行
- [ ] 支持手动启动/停止
- [ ] 支持暂停/恢复功能

### 优先级
Must Have

### 工作量估算
S (2-3天)

### 依赖
- US-001: 市场数据采集
- US-002: AI决策生成
- US-003: 交易执行
- US-004: 风险管理

### 技术注意事项
- 使用 `schedule` 库实现定时任务
- 需要优雅的异常处理和恢复机制
- 考虑使用状态机管理交易流程

---

## US-006: CLI管理工具

**作为** 系统管理员
**我想要** 命令行工具管理交易机器人
**以便** 方便地启动、停止、监控系统

### 验收标准
- [ ] `bot start` - 启动交易机器人
- [ ] `bot stop` - 停止交易机器人
- [ ] `bot status` - 查看运行状态
- [ ] `bot positions` - 查看当前持仓
- [ ] `bot history` - 查看交易历史
- [ ] `bot config` - 查看/修改配置

### 优先级
Should Have

### 工作量估算
S (2-3天)

### 依赖
- US-005: 自动化交易循环

### 技术注意事项
- 使用 `click` 或 `typer` 构建CLI
- 需要进程管理(考虑使用 systemd 或 supervisor)
- 配置文件使用 YAML

---

## US-007: 日志和监控

**作为** 系统管理员
**我想要** 详细的日志记录和实时监控
**以便** 快速发现和解决问题

### 验收标准
- [ ] 记录所有交易决策和执行结果
- [ ] 记录API调用和错误
- [ ] 日志分级(DEBUG/INFO/WARNING/ERROR)
- [ ] 日志轮转(按天或按大小)
- [ ] 关键错误实时告警(可选)

### 优先级
Should Have

### 工作量估算
S (1-2天)

### 依赖
- 无

### 技术注意事项
- 使用 `loguru` 库
- 日志格式：时间戳、级别、模块、消息
- 考虑集成 Sentry 用于错误追踪

---

## US-008: Web监控仪表盘

**作为** 交易员
**我想要** Web界面实时查看交易状态
**以便** 无需登录服务器即可监控系统

### 验收标准
- [ ] 显示实时持仓和盈亏
- [ ] 显示交易历史
- [ ] 显示AI对话历史
- [ ] 显示实时价格图表
- [ ] 支持启动/停止机器人
- [ ] 响应式设计(支持手机访问)

### 优先级
Nice to Have

### 工作量估算
L (5-10天)

### 依赖
- US-001 至 US-005
- REST API设计

### 技术注意事项
- 前端: React/Vue
- 后端: FastAPI
- 实时通信: WebSocket 或 SSE
- 数据持久化: SQLite 或 PostgreSQL

---

## US-009: 数据持久化

**作为** 交易系统
**我想要** 存储历史交易数据和AI对话
**以便** 回测和分析策略表现

### 验收标准
- [ ] 存储每次AI决策和对话内容
- [ ] 存储所有交易订单和成交记录
- [ ] 存储持仓历史和盈亏数据
- [ ] 支持按时间范围查询
- [ ] 数据导出功能(CSV/JSON)

### 优先级
Nice to Have

### 工作量估算
M (3-5天)

### 依赖
- US-001 至 US-005

### 技术注意事项
- 使用 SQLite (简单场景) 或 PostgreSQL (生产环境)
- 使用 SQLAlchemy ORM
- 定期数据备份

---

## US-010: 回测功能

**作为** 交易员
**我想要** 使用历史数据回测策略
**以便** 评估AI策略的历史表现

### 验收标准
- [ ] 使用历史K线数据模拟交易
- [ ] 计算历史收益率、夏普比率、最大回撤
- [ ] 生成回测报告
- [ ] 支持不同时间段的回测

### 优先级
Nice to Have

### 工作量估算
M (3-5天)

### 依赖
- US-001: 市场数据采集
- US-009: 数据持久化

### 技术注意事项
- 需要下载历史K线数据
- 模拟订单撮合逻辑
- 考虑使用 backtrader 库

---

## 用户故事优先级总结

### Must Have (核心功能 - Phase 1-5)
- US-001: 市场数据采集
- US-002: AI决策生成
- US-003: 交易执行
- US-004: 风险管理
- US-005: 自动化交易循环

### Should Have (重要功能 - Phase 6)
- US-006: CLI管理工具
- US-007: 日志和监控

### Nice to Have (增强功能 - 后续优化)
- US-008: Web监控仪表盘
- US-009: 数据持久化
- US-010: 回测功能

---

## 总工作量估算

- Must Have: 17-25天
- Should Have: 3-5天
- Nice to Have: 11-20天

**总计**: 31-50天 (约 6-10周)

---

## 参考
- `docs/00_research/nof1_ai_analysis.md`: NoF1.ai 功能分析
- `ROADMAP.md`: 项目路线图
- `.claude/project_rules.md`: 开发规则
